import telebot
import requests
import sqlite3
import pandas as pd

bot = telebot.TeleBot("1069609930:AAEqmpGa-3ToStHSwQM0vVjdX53LGAdLGKc")




def menu(key_lst,message,name,year):
    year1 = str(int(year) - 1)
    user_markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    user_markup.one_time_keyboard = True
    for i in key_lst:
        user_markup.row(i)
    bot.send_message(message.chat.id, "Выбранный период: " + year1 +"-"+year+" гг." + "\nТекущая компания: "+ name + "\nВыберите интересующий пункт:", reply_markup=user_markup)

def menu_2(message,name):
    key_lst2=["Комментарий "+"("+name+")","Назад","Завершить анализ деятельности выбранной компании"]
    user_markup2 = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    user_markup2.one_time_keyboard = True
    for i in key_lst2:
        user_markup2.row(i)
    bot.send_message(message.chat.id,'Выберите интересующий пункт:',reply_markup=user_markup2)

def menu_3(message):
    key_lst3 = ["Назад", "Завершить анализ деятельности выбранной компании"]
    user_markup3 = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    user_markup3.one_time_keyboard = True
    for i in key_lst3:
        user_markup3.row(i)
    bot.send_message(message.chat.id, 'Выберите интересующий пункт:', reply_markup=user_markup3)


general=[]

commentfinn=[]
dslst=[]
llst=[]
finlst=[]
rentlst=[]

lst_year = []
lst_name = []
assets_previous_year = []
balance_sheets = {}
balance_current_year = {}
balance_previous_year = {}
pl_current_year = {}
pl_previous_year = {}

absliq = []
absliqst1="Рекомендуется увеличить объем денежной массы."
absliqst2="Существует риск нехватки денежных средств для обеспечения текущих обязательств."
absliqst3="Рекомендуется использоваться сформировавшийся избыток денежных средств."
absliqst4="Существуют возможности получения дполнительной прибыли."
absliqst5="Организация обладает необходимым количество денежных средств."

quickliq = []
quickliq1="Вероятен риск потери потенциальных инвесторов. Возможен отказ от кредитования."
quickliq2="Платежеспособность предприятия улучшается. Ускоряется оборачиваемость собственных средств."
quickliq3="Организация обладает приемлемым объемом ликвидных ресурсов."

currentliq = []
currentliq1="Рекомендуется проведение мероприятий по сокращению кредиторской задолженности и снижению оборотных активов."
currentliq2="Существуют трудности в покрытии текущих обязательств."
currentliq3="Рекомендуется улучшить доступ к краткосрочному кредитованию."
currentliq4="Оборотные активы используются недостаточно активно."
currentliq5="Показетель текущей ликвидности находится в оптимальном диапазоне."

fintotal = []
finca = []
finst = []

ros = []
roe = []
roa = []
rfa = []
rca = []

@bot.message_handler(content_types=["text"])
def get_message(message):
    key_lst = ['Анализ динамики и структуры бух. отчетности', "Анализ ликвидности", "Анализ финансовой независимости","Анализ рентабельности","Завершить анализ деятельности выбранной компании"]
    msg=message.text
    if msg[:9]=="https://e":
        conn = sqlite3.connect(":memory:")
        cursor = conn.cursor()
        try:
            tables = pd.read_html(msg)
            balance_sheet = tables[0]
            profits_and_losses = tables[1]
            for row in balance_sheet.itertuples():
                sheets = row._1.replace('(', '-').replace(')', '').replace(u'\xa0', u'')
                balance_value_current = row._3.replace(' ', '').replace('(', '-').replace(')', '').replace(u'\xa0', u'')
                balance_value_previous = row._4.replace(' ', '').replace('(', '-').replace(')', '').replace(u'\xa0',
                                                                                                            u'')
                code_balance = row._2
                try:
                    balance_current_year[code_balance] = int(balance_value_current)
                    balance_previous_year[code_balance] = int(balance_value_previous)
                    balance_sheets[code_balance] = sheets
                except:
                    balance_current_year[code_balance] = balance_value_current
                    balance_previous_year[code_balance] = balance_value_previous
            for row in profits_and_losses.itertuples():
                pl_value_current = row._3.replace(' ', '').replace('(', '-').replace(')', '').replace(u'\xa0', u'')
                pl_value_previous = row._4.replace(' ', '').replace('(', '-').replace(')', '').replace(u'\xa0', u'')
                code_pl = row._2
                try:
                    pl_current_year[code_pl] = int(pl_value_current)
                    pl_previous_year[code_pl] = int(pl_value_previous)
                except:
                    pl_current_year[code_pl] = pl_value_current
                    pl_previous_year[code_pl] = pl_value_previous
            balance_sheet_lines = []
            for i in range(1, 8):
                if i == 1:
                    for j in range(10):
                        if j == 0:
                            balance_sheet_lines.append('1' + str(i) + '00')
                        else:
                            balance_sheet_lines.append('1' + str(i) + str(j * 10))
                elif i == 2:
                    for j in range(7):
                        if j == 0:
                            balance_sheet_lines.append('1' + str(i) + '00')
                        else:
                            balance_sheet_lines.append('1' + str(i) + str(j * 10))
                elif i == 3:
                    for j in range(8):
                        if j == 0:
                            balance_sheet_lines.append('1' + str(i) + '00')
                        else:
                            balance_sheet_lines.append('1' + str(i) + str(j * 10))
                elif i == 4 or i == 5:
                    for j in range(6):
                        if j == 0:
                            balance_sheet_lines.append('1' + str(i) + '00')
                        else:
                            balance_sheet_lines.append('1' + str(i) + str(j * 10))
                elif i == 6 or i == 7:
                    balance_sheet_lines.append('1' + str(i) + '00')
            pl_sheet_lines = []
            for i in range(1, 10):
                if i == 1 or i == 2 or i == 5:
                    for j in range(3):
                        if j == 0:
                            pl_sheet_lines.append('2' + str(i) + '00')
                        else:
                            pl_sheet_lines.append('2' + str(i) + str(j * 10))
                elif i == 3:
                    for j in range(6):
                        if j == 0:
                            pl_sheet_lines.append('2' + str(i) + '00')
                        else:
                            pl_sheet_lines.append('2' + str(i) + str(j * 10))
                elif i == 4:
                    for j in range(7):
                        if j == 0:
                            pl_sheet_lines.append('2' + str(i) + '00')
                        elif j == 2:
                            pl_sheet_lines.append('2' + str(i) + str(j) + '1')
                        else:
                            pl_sheet_lines.append('2' + str(i) + str(j * 10))
                elif i == 9:
                    for j in range(2):
                        if j == 0:
                            pl_sheet_lines.append('2' + str(i) + '00')
                        else:
                            pl_sheet_lines.append('2' + str(i) + str(j * 10))
            for sheet in balance_sheet_lines:
                if sheet not in balance_current_year:
                    balance_current_year[sheet] = 0
                if sheet not in balance_previous_year:
                    balance_previous_year[sheet] = 0
            for sheet in pl_sheet_lines:
                if sheet not in pl_previous_year:
                    pl_previous_year[sheet] = 0
                if sheet not in pl_current_year:
                    pl_current_year[sheet] = 0
            balance_tuple_assets = []
            balance_tuple_liabilities = []
            try:
                for key in balance_sheets:
                    for i in balance_previous_year:
                        for j in balance_current_year:
                            if key[0:2] == '13' or key[0:2] == '14' or key[0:2] == '15' or key[0:2] == '17':
                                break
                            elif key == i and key == j:
                                spgravity_previous = round(
                                    balance_previous_year[i] / balance_previous_year['1600'] * 100,
                                    2)
                                spgravity_current = round(balance_current_year[j] / balance_current_year['1600'] * 100,
                                                          2)
                                lst = [balance_sheets[key], balance_previous_year[i], spgravity_previous,
                                       balance_current_year[j],
                                       spgravity_current, balance_current_year[j] - balance_previous_year[i],
                                       round(spgravity_current - spgravity_previous, 4)]
                                balance_tuple_assets.append(tuple(lst))
                for key in balance_sheets:
                    for i in balance_previous_year:
                        for j in balance_current_year:
                            if key[0:2] == '11' or key[0:2] == '12' or key[0:2] == '16':
                                break
                            elif key == i and key == j:
                                spgravity_previous = round(
                                    balance_previous_year[i] / balance_previous_year['1600'] * 100, 2)
                                spgravity_current = round(balance_current_year[j] / balance_current_year['1600'] * 100,
                                                          2)
                                lst = [balance_sheets[key], balance_previous_year[i], spgravity_previous,
                                       balance_current_year[j], spgravity_current,
                                       balance_current_year[j] - balance_previous_year[i],
                                       round(spgravity_current - spgravity_previous, 4)]
                                balance_tuple_liabilities.append(tuple(lst))
            except:
                dslst.append(1)

            year = balance_current_year['Код строки'][11:15]
            cursor.execute(
                "CREATE TABLE IF NOT EXISTS assets_analysis(Статья_бухгалтерского_баланса TEXT, На_начало_" + year + "_года INTEGER,"
                "Удельный_вес_в_общем_итоге_баланса_ INTEGER, На_конец_" + year + "_года INTEGER,"
                "Удельный_вес_в_общем_итоге_баланса INTEGER, Абсолютное_изменение INTEGER, Изменение_удельного_веса INTEGER);")
            cursor.execute(
                "CREATE TABLE IF NOT EXISTS liabilities_analysis(Статья_бухгалтерского_баланса TEXT, На_начало_" + year + "_года INTEGER,"
                "Удельный_вес_в_общем_итоге_баланса_ INTEGER, На_конец_" + year + "_года INTEGER,"
                "Удельный_вес_в_общем_итоге_баланса INTEGER, Абсолютное_изменение INTEGER, Изменение_удельного_веса INTEGER);")
            cursor.executemany(
                "INSERT INTO assets_analysis (Статья_бухгалтерского_баланса, На_начало_" + year + "_года,"
                "Удельный_вес_в_общем_итоге_баланса_, На_конец_" + year + "_года,Удельный_вес_в_общем_итоге_баланса,"
                "Абсолютное_изменение, Изменение_удельного_веса) values(?,?,?,?,?,?,?)", balance_tuple_assets)
            cursor.executemany(
                "INSERT INTO liabilities_analysis (Статья_бухгалтерского_баланса, На_начало_" + year + "_года,"
                "Удельный_вес_в_общем_итоге_баланса_, На_конец_" + year + "_года, Удельный_вес_в_общем_итоге_баланса,"
                "Абсолютное_изменение, Изменение_удельного_веса) values(?,?,?,?,?,?,?)", balance_tuple_liabilities)

            df_assets = pd.read_sql("SELECT * FROM assets_analysis", conn)
            df_liabilities = pd.read_sql("SELECT * FROM liabilities_analysis", conn)
            writer = pd.ExcelWriter('structure_dynamic.xlsx', engine='xlsxwriter')
            df_assets.to_excel(writer, index = False, sheet_name='Активы')
            df_liabilities.to_excel(writer, index = False, sheet_name='Пассивы')
            worksheet1 = writer.sheets['Активы']
            worksheet2 = writer.sheets['Пассивы']
            worksheet1.set_column('A:A', 70)
            worksheet2.set_column('A:A', 70)
            worksheet1.set_column('B:B', 20)
            worksheet2.set_column('B:B', 20)
            worksheet1.set_column('C:C', 40)
            worksheet2.set_column('C:C', 40)
            worksheet1.set_column('D:D', 20)
            worksheet2.set_column('D:D', 20)
            worksheet1.set_column('E:E', 40)
            worksheet2.set_column('E:E', 40)
            worksheet1.set_column('F:F', 24)
            worksheet2.set_column('F:F', 24)
            worksheet1.set_column('G:G', 27)
            worksheet2.set_column('G:G', 27)
            writer.save()
            # ликвидность
            try:
                current_liabilities1 = balance_previous_year['1500'] - balance_previous_year['1530']
                current_liabilities2 = balance_current_year['1500'] - balance_current_year['1530']
                abs_liq1 = round((balance_previous_year['1240'] + balance_previous_year['1250']) / current_liabilities1,
                                 2)
                abs_liq2 = round((balance_current_year['1240'] + balance_current_year['1250']) / current_liabilities2,
                                 2)
                abs_liq_change = round(abs_liq2 - abs_liq1, 3)
                absliq.append(abs_liq2)
                absliq.append(abs_liq_change)
                quick_liq1 = round(
                    (balance_previous_year['1240'] + balance_previous_year['1250'] + balance_previous_year['1230']) /
                    current_liabilities1, 2)
                quick_liq2 = round(
                    (balance_current_year['1240'] + balance_current_year['1250'] + balance_current_year['1230']) /
                    current_liabilities2, 2)
                quick_liq_change = round(quick_liq2 - quick_liq1, 3)
                quickliq.append(quick_liq2)
                quickliq.append(quick_liq_change)
                current_liq1 = round(balance_previous_year['1200'] / current_liabilities1, 2)
                current_liq2 = round(balance_current_year['1200'] / current_liabilities2, 2)
                current_liq_change = round(current_liq2 - current_liq1, 3)
                currentliq.append(current_liq2)
                currentliq.append(current_liq_change)
            except:
                llst.append(1)
            # коэффициент общей финансовой независимости
            try:
                fin_in_total1 = round(balance_previous_year['1300'] / balance_previous_year['1600'], 2)
                fin_in_total2 = round(balance_current_year['1300'] / balance_current_year['1600'], 2)
                fin_in_total_change = round(fin_in_total2 - fin_in_total1, 3)
                fintotal.append(str(fin_in_total2))
                fintotal.append(str(fin_in_total_change))
                # коэффициент финансовой независимости в части оборотных активов
                equity_in_circulation1 = balance_previous_year['1300'] - balance_previous_year['1100']
                equity_in_circulation2 = balance_current_year['1300'] - balance_current_year['1100']
                fin_in_ca1 = round(equity_in_circulation1 / balance_previous_year['1200'], 2)
                fin_in_ca2 = round(equity_in_circulation2 / balance_previous_year['1200'], 2)
                fin_in_ca_change = round(fin_in_ca2 - fin_in_ca1, 3)
                finca.append(str(fin_in_ca2))
                finca.append(str(fin_in_ca_change))
                if balance_previous_year['1210'] != 0:
                    fin_in_st1 = round(equity_in_circulation1 / balance_previous_year['1210'], 2)
                    fin_in_st2 = round(equity_in_circulation2 / balance_previous_year['1210'], 2)
                    fin_in_st_change = round(fin_in_st2 - fin_in_st1, 3)
                    finst.append(str(fin_in_st2))
                    finst.append(str(fin_in_st_change))
                pos_change = 'За отчетный период наблюдается положительная динамика коэффиициентов финансовой независимости. ' \
                             'Так, коэффициент общей финансовой независимости увеличился на ' + str(fin_in_total_change) + ', ' \
                             'а коэффициент финансовой независимости в части формирования оборотных активов увеличился' \
                             'на ' + str(fin_in_ca_change) + '. Рост коэффициентов свидетельствует о том, что организация все ' \
                             'больше полагается на собственные источники финансирования. Таким образом, за отчетный период снизилась ' \
                             'финансовая зависимость организации от заемных источников.'
                pos_total_neg_ca = 'За отчетный период наблюдается положительная динамика коэффиициента общей финансовой независимости ' \
                                   'и отрицательная динамика коэффициента финансовой независимости компании в части формирования оборотных активов. ' \
                                   'Так, коэффициент общей финансовой независимости увеличился на ' + str(fin_in_total_change) + ', ' \
                                   'а коэффициент финансовой независимости в части формирования оборотных активов снизился ' \
                                   'на ' + str(fin_in_ca_change) + '.'
                pos_total_neut_ca = 'За отчетный период наблюдается положительная динамика коэффиициента общей финансовой независимости, ' \
                                    'коэффициент финансовой независимости компании в части формирования оборотных активов ' \
                                    'остался на неизменном уровне. Так, рост коэффициента общей финансовой независимости ' \
                                    'составил ' + str(fin_in_total_change) + '. Рост коэффициента общей финансовой независимости свидетельствует о том, что организация все ' \
                                    'больше полагается на собственные источники финансирования. Таким образом, за отчетный период снизилась ' \
                                    'финансовая зависимость организации от заемных источников.'
                neut_change = 'За отчетный период коэффициенты финансовой независимости компании остались на неизменном уровне.'
                neut_total_pos_ca = 'За отчетный период наблюдается положительная динамика коэффициента финанасовой независимости в части ' \
                                    'формирования оборотных активов, коэффициент общей финансовой независимости остался на неизменном уровне.' \
                                    'Так, коэффициент финансовой независимости в части формирования оборотных активов увеличился' \
                                    'на ' + str(fin_in_ca_change) + '. Рост коэффициента финансовой независимости в части ' \
                                    'формирования оборотных активов свидетельствует о том, что организация все ' \
                                    'больше полагается на собственные источники финансирования. Таким образом, за отчетный период снизилась ' \
                                    'финансовая зависимость организации от заемных источников.'
                neut_total_neg_ca = 'За отчетный период наблюдается отрицательная динамика коэффициента финанасовой независимости в части ' \
                                    'формирования оборотных активов, коэффициент общей финансовой независимости остался на неизменном уровне.' \
                                    'Так, коэффициент финансовой независимости в части формирования оборотных активов снизился' \
                                    'на ' + str(fin_in_ca_change) + '. Снижение коэффициента финансовой независимости в части ' \
                                    'формирования оборотных активов свидетельствует о том, что организация все ' \
                                    'больше полагается на заемные источники финансирования. Таким образом, за отчетный период увеличилась ' \
                                    'финансовая зависимость организации от заемных источников.'
                neg_total_pos_ca = 'За отчетный период наблюдается отрицательная динамика коэффиициента общей финансовой независимости ' \
                                   'и положительная динамика коэффициента финансовой независимости компании в части формирования оборотных активов. ' \
                                   'Так, коэффициент общей финансовой независимости снизился на ' + str(fin_in_total_change) + ', ' \
                                   'а коэффициент финансовой независимости в части формирования оборотных активов увеличился ' \
                                   'на ' + str(fin_in_ca_change) + '.'
                neg_total_neut_ca = 'За отчетный период наблюдается отрицательная динамика коэффиициента общей финансовой независимости, ' \
                                    'коэффициент финансовой независимости компании в части формирования оборотных активов ' \
                                    'остался на неизменном уровне. Так, снижениие коэффициента общей финансовой независимости ' \
                                    'составило ' + str(fin_in_total_change) + '. Снижение коэффициента общей финансовой независимости ' \
                                    'свидетельствует о том, что организация все ' \
                                    'больше полагается на заемные источники финансирования. Таким образом, за отчетный период увеличилась ' \
                                    'финансовая зависимость организации от заемных источников.'
                neg_change = 'За отчетный период наблюдается отрицательная динамика коэффиициентов финансовой независимости. ' \
                             'Так, коэффициент общей финансовой независимости снизился на ' + str(fin_in_total_change) + ', ' \
                             'а коэффициент финансовой независимости в части формирования оборотных активов снизился' \
                             'на ' + str(fin_in_ca_change) + '. Снижение коэффициентов свидетельствует о том, что организация все ' \
                             'больше полагается на заемные источники финансирования. Таким образом, за отчетный период увеличилась ' \
                             'финансовая зависимость организации от заемных источников.'
                # шаблоны по нормативам
                total_ok_ca_ok = 'Фактические значения обоих коэффициентов находятся в пределах нормативного значения'
                total_ok_ca_less = 'Фактическое значение коэффициента общей финансовой независимости находится в пределах норматива. ' \
                                   'Тем не менее, фактическое значение коэффициента фианансовой независимости в части формирования ' \
                                   'оборотных активов ниже нормативного значения, что говорит о зависимости организации  от заемных источников ' \
                                   '(обязательств перед кредиторами, банками и другими заимодавцами) при формировании ею своих оборотных активов.'
                total_ok_ca_more = 'Фактическое значение коэффициента общей финансовой независимости находится в пределах норматива. ' \
                                   'Тем не менее, фактическое значение коэффициента фианансовой независимости в части формирования оборотных активов выше' \
                                   'нормативного значения, что может свидетельствовать о сдерживании темпов развития предприятия, ' \
                                   'так как отказавшись от привлечения заемного капитала, организация лишается дополнительного ' \
                                   'источника финансирования прироста оборотных активов, за счет которых можно увеличить доходы.'
                total_less_ca_ok = 'Фактическое значение коэффициента финансовой независимости в части формирования оборотных активов' \
                                   'находится в пределах норматива. Тем не менее, фактическое значение коэффициента общей фианансовой ' \
                                   'независимости ниже нормативного значения, что говорит о зависимости организации  от заемных источников ' \
                                   '(обязательств перед кредиторами, банками и другими заимодавцами) при формировании ею своих активов.'
                total_less_ca_less = 'Фактические значения обоих коэффициентов находятся ниже нормативного значения, что говорит ' \
                                     'о зависимости организации от заемных источников (обязательств перед кредиторами, банками и другими заимодавцами).'
                total_less_ca_more = 'Фактическое значение коэффициента общей финансовой независимости ниже нормативного значения. ' \
                                     'Тем не менее, фактическое значение коэффициента фианансовой независимости в части формирования ' \
                                     'оборотных активов выше нормативного значения.'
                total_more_ca_ok = 'Фактическое значение коэффициента финансовой независимости в части формирования оборотных активов ' \
                                   'находится в пределах норматива. Тем не менее, фактическое значение коэффициента общей фианансовой ' \
                                   'независимости выше нормативного значения, что может свидетельствовать о сдерживании темпов развития предприятия, ' \
                                   'так как отказавшись от привлечения заемного капитала, организация лишается дополнительного ' \
                                   'источника финансирования прироста активов, за счет которых можно увеличить доходы.'
                total_more_ca_less = 'Фактическое значение коэффициента общей финансовой независимости нахожится выше нормативного, а ' \
                                     'коэффициента финансовой независимости в части формирования оборотных активов - ниже нормативного.'
                total_more_ca_more = 'Фактические значения обоих коэффициентов находятся выще нормативного значения, что может ' \
                                     'свидетельствовать о сдерживании темпов развития предприятия, так как отказавшись от привлечения ' \
                                     'заемного капитала, организация лишается дополнительного источника финансирования прироста ' \
                                     'активов, за счет которых можно увеличить доходы.'
                if fin_in_total_change > 0:
                    if 0.6 <= fin_in_total2 <= 0.7:
                        if fin_in_ca_change > 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = pos_change + ' ' + total_ok_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = pos_change + ' ' + total_ok_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = pos_change + ' ' + total_ok_ca_more
                        elif fin_in_ca_change < 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = pos_total_neg_ca + ' ' + total_ok_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = pos_total_neg_ca + ' ' + total_ok_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = pos_total_neg_ca + ' ' + total_ok_ca_more
                        elif fin_in_ca_change == 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = pos_total_neut_ca + ' ' + total_ok_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = pos_total_neut_ca + ' ' + total_ok_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = pos_total_neut_ca + ' ' + total_ok_ca_more
                    elif fin_in_total2 < 0.6:
                        if fin_in_ca_change > 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = pos_change + ' ' + total_less_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = pos_change + ' ' + total_less_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = pos_change + ' ' + total_less_ca_more
                        elif fin_in_ca_change < 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = pos_total_neg_ca + ' ' + total_less_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = pos_total_neg_ca + ' ' + total_less_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = pos_total_neg_ca + ' ' + total_less_ca_more
                        elif fin_in_ca_change == 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = pos_total_neut_ca + ' ' + total_less_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = pos_total_neut_ca + ' ' + total_less_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = pos_total_neut_ca + ' ' + total_less_ca_more
                    elif fin_in_total2 > 0.7:
                        if fin_in_ca_change > 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = pos_change + ' ' + total_more_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = pos_change + ' ' + total_more_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = pos_change + ' ' + total_more_ca_more
                        elif fin_in_ca_change < 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = pos_total_neg_ca + ' ' + total_more_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = pos_total_neg_ca + ' ' + total_more_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = pos_total_neg_ca + ' ' + total_more_ca_more
                        elif fin_in_ca_change == 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = pos_total_neut_ca + ' ' + total_more_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = pos_total_neut_ca + ' ' + total_more_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = pos_total_neut_ca + ' ' + total_more_ca_more
                elif fin_in_total_change < 0:
                    if 0.6 <= fin_in_total2 <= 0.7:
                        if fin_in_ca_change > 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neg_total_pos_ca + ' ' + total_ok_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neg_total_pos_ca + ' ' + total_ok_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neg_total_pos_ca + ' ' + total_ok_ca_more
                        elif fin_in_ca_change < 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neg_change + ' ' + total_ok_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neg_change + ' ' + total_ok_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neg_change + ' ' + total_ok_ca_more
                        elif fin_in_ca_change == 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neg_total_neut_ca + ' ' + total_ok_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neg_total_neut_ca + ' ' + total_ok_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neg_total_neut_ca + ' ' + total_ok_ca_more
                    elif fin_in_total2 < 0.6:
                        if fin_in_ca_change > 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neg_total_pos_ca + ' ' + total_less_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neg_total_pos_ca + ' ' + total_less_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neg_total_pos_ca + ' ' + total_less_ca_more
                        elif fin_in_ca_change < 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neg_change + ' ' + total_less_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neg_change + ' ' + total_less_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neg_change + ' ' + total_less_ca_more
                        elif fin_in_ca_change == 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neg_total_neut_ca + ' ' + total_less_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neg_total_neut_ca + ' ' + total_less_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neg_total_neut_ca + ' ' + total_less_ca_more
                    elif fin_in_total2 > 0.7:
                        if fin_in_ca_change > 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neg_total_pos_ca + ' ' + total_more_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neg_total_pos_ca + ' ' + total_more_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neg_total_pos_ca + ' ' + total_more_ca_more
                        elif fin_in_ca_change < 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neg_change + ' ' + total_more_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neg_change + ' ' + total_more_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neg_change + ' ' + total_more_ca_more
                        elif fin_in_ca_change == 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neg_total_neut_ca + ' ' + total_more_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neg_total_neut_ca + ' ' + total_more_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neg_total_neut_ca + ' ' + total_more_ca_more
                elif fin_in_total_change == 0:
                    if 0.6 <= fin_in_total2 <= 0.7:
                        if fin_in_ca_change > 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neut_total_pos_ca + ' ' + total_ok_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neut_total_pos_ca + ' ' + total_ok_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neut_total_pos_ca + ' ' + total_ok_ca_more
                        elif fin_in_ca_change < 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neut_total_neg_ca + ' ' + total_ok_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neut_total_neg_ca + ' ' + total_ok_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neut_total_neg_ca + ' ' + total_ok_ca_more
                        elif fin_in_ca_change == 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neut_change + ' ' + total_ok_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neut_change + ' ' + total_ok_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neut_change + ' ' + total_ok_ca_more
                    elif fin_in_total2 < 0.6:
                        if fin_in_ca_change > 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neut_total_pos_ca + ' ' + total_less_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neut_total_pos_ca + ' ' + total_less_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neut_total_pos_ca + ' ' + total_less_ca_more
                        elif fin_in_ca_change < 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neut_total_neg_ca + ' ' + total_less_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neut_total_neg_ca + ' ' + total_less_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neut_total_neg_ca + ' ' + total_less_ca_more
                        elif fin_in_ca_change == 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neut_change + ' ' + total_less_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neut_change + ' ' + total_less_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neut_change + ' ' + total_less_ca_more
                    elif fin_in_total2 > 0.7:
                        if fin_in_ca_change > 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neut_total_pos_ca + ' ' + total_more_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neut_total_pos_ca + ' ' + total_more_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neut_total_pos_ca + ' ' + total_more_ca_more
                        elif fin_in_ca_change < 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neut_total_neg_ca + ' ' + total_more_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neut_total_neg_ca + ' ' + total_more_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neut_total_neg_ca + ' ' + total_more_ca_more
                        elif fin_in_ca_change == 0:
                            if 0.4 <= fin_in_ca2 <= 0.6:
                                comment_fin_in = neut_change + ' ' + total_more_ca_ok
                            elif fin_in_ca2 < 0.4:
                                comment_fin_in = neut_change + ' ' + total_more_ca_less
                            elif fin_in_ca2 > 0.6:
                                comment_fin_in = neut_change + ' ' + total_more_ca_more
                commentfinn.append(comment_fin_in)
            except:
                finlst.append(1)
            # рентабельность (все по чистой прибыли)
            try:
                ROS1 = round(100 * (pl_previous_year['2400'] / pl_previous_year['2110']), 2)
                ROS2 = round(100 * (pl_current_year['2400'] / pl_current_year['2110']), 2)
                ROS_change = round(ROS2 - ROS1, 3)
                ros.append(str(ROS2))
                ros.append(str(ROS_change))
                ROE1 = round(100 * (pl_previous_year['2400'] / balance_previous_year['1300']), 2)
                ROE2 = round(100 * (pl_current_year['2400'] / balance_current_year['1300']), 2)
                ROE_change = round(ROE2 - ROE1, 3)
                roe.append(str(ROE2))
                roe.append(str(ROE_change))
                ROA1 = round(100 * (pl_previous_year['2400'] / balance_previous_year['1600']), 2)
                ROA2 = round(100 * (pl_current_year['2400'] / balance_current_year['1600']), 2)
                ROA_change = round(ROA2 - ROA1, 3)
                roa.append(str(ROA2))
                roa.append(str(ROA_change))
                RFA1 = round(100 * (pl_previous_year['2400'] / balance_previous_year['1150']), 2)  # ОПФ
                RFA2 = round(100 * (pl_current_year['2400'] / balance_current_year['1150']), 2)
                RFA_change = round(RFA2 - RFA1, 3)
                rfa.append(str(RFA2))
                rfa.append(str(RFA_change))
                RCA1 = round(100 * (pl_previous_year['2400'] / balance_previous_year['1200']), 2)  # ОА
                RCA2 = round(100 * (pl_current_year['2400'] / balance_current_year['1200']), 2)
                RCA_change = round(RCA2 - RCA1, 3)
                rca.append(str(RCA2))
                rca.append(str(RCA_change))
            except:
                rentlst.append(1)
            response = requests.get(msg)
            a = response.text.find('<title>')
            b = response.text.find('</title>')
            slice = response.text[a + 7:b]
            name_of_company = slice.split(' ')[6] + ' ' + slice.split('&quot;')[1]
            lst_name.append(name_of_company)
            lst_year.append(year)
            lst_name.append(name_of_company)
            general.clear()
            general.append(1)
            menu(key_lst, message, lst_name[0], lst_year[0])
        except:
            bot.send_message(message.chat.id,"Что-то пошло не так. Возможно, отправлена ссылка не на отчетность. \nУбедитесь, что скопирована корректная ссылка и попробуйте снова.")
            bot.send_message(message.chat.id,'Скопируйте и отправьте ссылку на финансовую отчетность компании с сайта: https://e-ecolog.ru/sitesearch')
            pass
    elif msg=="Анализ динамики и структуры бух. отчетности":
        if len(general)==1:
            if len(dslst)==0:
                doc = open('structure_dynamic.xlsx', 'rb')
                bot.send_document(message.chat.id, doc)
                menu_3(message)
            else:
                bot.send_message(message.chat.id,"Для данной компании возникла ошибка при расчете выбранного вами пункта.")
                menu_3(message)
        else:
            bot.send_message(message.chat.id, "Не выбрана компания. \nСкопируйте и отправьте ссылку на финансовую отчетность компании с сайта: https://e-ecolog.ru/sitesearch")
    elif msg=='Анализ ликвидности':
        if len(general)==1:
            if len(llst)==0:
                bot.send_message(message.chat.id,"Значения на "+lst_year[0]+" г."+"\n"+"\nКоэффициент абсолютной ликвидности: "+str(absliq[0])+"\nИзменение: "+str(absliq[1])+"\nНорматив: 0.2 - 0.5"+"\n"+
                         "\nКоэффициент быстрой ликвидности: "+str(quickliq[0])+"\nИзменение: "+str(quickliq[1])+"\nНорматив: 0.7 - 1.0"+"\n"+
                         "\nКоэффициент текущей ликвидности: "+str(currentliq[0])+"\nИзменение: "+str(currentliq[1])+"\nНорматив: 1.5 - 2.5")
                menu_2(message, msg)
            else:
                bot.send_message(message.chat.id, "Для данной компании возникла ошибка при расчете выбранного вами пункта.")
                menu_3(message)
        else:
            bot.send_message(message.chat.id, "Не выбрана компания. \nСкопируйте и отправьте ссылку на финансовую отчетность компании с сайта: https://e-ecolog.ru/sitesearch")
    elif msg=="Комментарий (Анализ ликвидности)":
        if absliq[0]<0.2:
            abscom=absliqst1+"\n"+absliqst2
        elif 0.2<=absliq[0]<=0.5:
            abscom=absliqst5
        else:
            abscom=absliqst3+"\n"+absliqst4
        if int(quickliq[0])<0.7:
            quickcom=quickliq1
        elif 0.7<=quickliq[0]<=1:
            quickcom=quickliq3
        else:
            quickcom=quickliq2
        if currentliq[0]<1.5:
            currentcom=currentliq1+"\n"+currentliq2
        elif 1.5<=currentliq[0]<=2.5:
            currentcom=currentliq5
        else:
            currentcom=currentliq3+"\n"+currentliq4
        bot.send_message(message.chat.id,abscom+"\n"+"\n"+quickcom+"\n"+"\n"+currentcom)
        menu_3(message)
    elif msg=='Анализ рентабельности':
        if len(general)==1:
            if len(rentlst)==0:
                bot.send_message(message.chat.id,
                         "Значения на " + lst_year[0] + " г., %" + "\n" + "\nРентабельность продаж: " +
                         ros[0] + "\nИзменение: " + ros[1] + "\n" + "\nРентабельность собственного капитала: " + roe[0] + "\nИзменение: " +
                         roe[1] + "\n" + "\nРентабельность активов: " +roa[0] + "\nИзменение: " + roa[1]+ "\n" + "\nРентабельность текущих активов: " +
                         rfa[0] + "\nИзменение: " + rfa[1] + "\n" + "\nРентабельность основных средств: " + rca[0]+ "\nИзменение: " + rca[1])
                menu_3(message)
            else:
                bot.send_message(message.chat.id, "Для данной компании возникла ошибка при расчете выбранного вами пункта.")
                menu_3(message)
        else:
            bot.send_message(message.chat.id, "Не выбрана компания. \nСкопируйте и отправьте ссылку на финансовую отчетность компании с сайта: https://e-ecolog.ru/sitesearch")
    elif msg=="Назад":
        if len(general)==1:
            menu(key_lst,message,lst_name[0],lst_year[0])
        else:
            bot.send_message(message.chat.id,
                             "Не выбрана компания. \nСкопируйте и отправьте ссылку на финансовую отчетность компании с сайта: https://e-ecolog.ru/sitesearch")
    elif msg=='Анализ финансовой независимости':
        if len(general)==1:
            if len(finlst)==0:
                bot.send_message(message.chat.id,
                         "Значения на " + lst_year[0] + " г." + "\n" + "\nКоэффициент общей фин. независимости: " +
                         fintotal[0] + "\nИзменение: " + fintotal[1] + "\nНорматив: 0.6 - 0.7" + "\n" + "\nКоэффициент фин. независимости (ОА): " +
                         finca[0] + "\nИзменение: " + finca[1] + "\nНорматив: 0.4 - 0.6" + "\n" + "\nКоэффициент фин. независимости (запасы): " +
                         finst[0] + "\nИзменение: " + finst[1] + "\nНорматив: 0.6 - 0.8")
                menu_2(message, msg)
            else:
                bot.send_message(message.chat.id, "Для данной компании возникла ошибка при расчете выбранного вами пункта.")
                menu_3(message)
        else:
            bot.send_message(message.chat.id, "Не выбрана компания. \nСкопируйте и отправьте ссылку на финансовую отчетность компании с сайта: https://e-ecolog.ru/sitesearch")
    elif msg=="Комментарий (Анализ финансовой независимости)":
        bot.send_message(message.chat.id, commentfinn[0])
        menu_3(message)
    elif msg=='Завершить анализ деятельности выбранной компании':
        commentfinn.clear()
        general.clear()
        dslst.clear()
        llst.clear()
        finlst.clear()
        rentlst.clear()
        lst_year.clear()
        lst_name.clear()
        assets_previous_year.clear()
        balance_sheets.clear()
        balance_current_year.clear()
        balance_previous_year.clear()
        pl_current_year.clear()
        pl_previous_year.clear()
        absliq.clear()
        quickliq.clear()
        currentliq.clear()
        fintotal.clear()
        finca.clear()
        finst.clear()
        ros.clear()
        roe.clear()
        roa.clear()
        rfa.clear()
        rca.clear()
        bot.send_message(message.chat.id, 'Чтобы начать новую сессию, скопируйте и отправьте ссылку на финансовую отчетность компании с сайта: https://e-ecolog.ru/sitesearch')
        pass
    else:
        if len(general)==1:
            menu(key_lst, message, lst_name[0], lst_year[0])
        else:
            bot.send_message(message.chat.id, 'Скопируйте и отправьте ссылку на финансовую отчетность компании с сайта: https://e-ecolog.ru/sitesearch')

bot.polling(none_stop=True, interval=0)
